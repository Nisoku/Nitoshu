import { defineConfig, loadEnv } from "vite";
import { VitePWA } from "vite-plugin-pwa";
import { viteSingleFile } from "vite-plugin-singlefile";

export default defineConfig(({ mode }) => {
  const env = loadEnv(mode, process.cwd(), "");
  const isSingleFile = env.SINGLE_FILE === "true";

  return {
    base: "./",
    plugins: [
      VitePWA({
        registerType: "autoUpdate",
        includeAssets: ["robots.txt"],
        manifest: {
          name: "Nitoshu",
          short_name: "Nitoshu",
          start_url: "./",
          display: "standalone",
          theme_color: "#ffffff",
          background_color: "#ffffff",
          file_handlers: [
            {
              action: "/Nitoshu/",
              accept: {
                "text/*": [
                  ".txt",
                  ".md",
                  ".csv",
                  ".tsv",
                  ".json",
                  ".jsonc",
                  ".c",
                  ".h",
                  ".cpp",
                  ".hpp",
                  ".py",
                  ".pyw",
                  ".rb",
                  ".pl",
                  ".pm",
                  ".php",
                  ".sh",
                  ".zsh",
                  ".bash",
                  ".bat",
                  ".cmd",
                  ".ps1",
                  ".java",
                  ".go",
                  ".rs",
                  ".swift",
                  ".kt",
                  ".kts",
                  ".scala",
                  ".groovy",
                  ".r",
                  ".rmd",
                  ".tex",
                  ".js",
                  ".ts",
                  ".jsx",
                  ".tsx",
                  ".html",
                  ".css",
                  ".scss",
                  ".sass",
                  ".less",
                  ".vue",
                  ".svelte",
                  ".xml",
                  ".yml",
                  ".yaml",
                  ".log",
                  ".ini",
                  ".cfg",
                  ".conf",
                  ".env",
                  ".dockerfile",
                  ".dockerignore",
                  ".gitignore",
                  ".gitattributes",
                  ".makefile",
                  ".mk",
                  ".gradle",
                  ".pro",
                  ".properties",
                  ".lst",
                  ".asm",
                  ".s",
                  ".S",
                  ".enc",
                  ".dec",
                  ".out",
                ],
                "application/json": [".json", ".jsonc"],
                "application/xml": [".xml"],
                "application/javascript": [".js"],
                "application/x-yaml": [".yml", ".yaml"],
                "text/markdown": [".md"],
                "text/x-c": [".c", ".h"],
                "text/x-c++": [".cpp", ".hpp"],
                "text/x-python": [".py"],
                "text/x-shellscript": [".sh", ".zsh", ".bash"],
                "text/x-perl": [".pl", ".pm"],
                "text/x-php": [".php"],
                "text/x-java-source": [".java"],
                "text/x-rustsrc": [".rs"],
                "text/x-csharp": [".cs"],
                "text/x-go": [".go"],
                "text/x-sql": [".sql"],
              },
            },
          ],
        },
        pwaAssets: {
          config: true,
        },
        workbox: {
          // Required for PWA to find the inlined file
          globPatterns: ["**/*.{js,css,html,png,ico,json}"],
          runtimeCaching: [
            {
              urlPattern: /.*\.(js|css|html)$/,
              handler: "NetworkFirst",
              options: { cacheName: "app-shell" },
            },
            {
              urlPattern: /.*\.(png|ico|json)$/,
              handler: "CacheFirst",
              options: { cacheName: "assets" },
            },
          ],
        },
      }),
      // Conditionally add the plugin
      isSingleFile && viteSingleFile(),
    ].filter(Boolean),
    build: {
      sourcemap: true,
      outDir: "./dist",
      emptyOutDir: true,
      chunkSizeWarningLimit: 1000,
    },
  };
});
